<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Notes</title><meta name=apple-mobile-web-app-title content="Notes"><link rel=stylesheet href=/main.css></head><body><main class=index><article><a href=/>back</a><header><h1>Docker Golang <small>in notes</small></h1><small>2022-03-02</small></header><p>again this is for my self reference or for easy copy-paste for new projects.</p><p>Assume this is the production grade program we need to dockerize and run.</p><div class="src src-go"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;saying hello to the world&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Basic</h3><div id=outline-text-headline-1 class=outline-text-3><p>#-NAME: Dockerfile multistage build</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>FROM golang:1.14-alpine as builder
</span></span><span style=display:flex><span>WORKDIR /go/src/github.com/shabinesh/prog
</span></span><span style=display:flex><span>COPY main.go  .
</span></span><span style=display:flex><span>COPY vendor ./vendor
</span></span><span style=display:flex><span>RUN go build -o main .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FROM alpine:latest 
</span></span><span style=display:flex><span>RUN apk --no-cache add ca-certificates
</span></span><span style=display:flex><span>WORKDIR /
</span></span><span style=display:flex><span>COPY --from=0 /go/src/github.com/shabinesh/prog/main .
</span></span><span style=display:flex><span>CMD [&#34;./main&#34;]</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>If the service depends on private repositor</h3><div id=outline-text-headline-2 class=outline-text-3><ul><li>set the `GOPRIVATE`</li><li>Update the git to include github token (in this case)</li></ul><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>FROM golang:1.14-alpine AS builder
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>ARG GITHUB_TOKEN
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>WORKDIR /go/src/github.com/my-org/hello-service
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>RUN apk add --update bash make git curl ca-certificates
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Patch git to use a private token if one was provided</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>RUN <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -z <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git config --global --add url.<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>@github.com/my-org/&#34;</span>.insteadOf <span style=color:#e6db74>&#34;git@github.com:my-org/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git config --global --add url.<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>@github.com/my-org/&#34;</span>.insteadOf <span style=color:#e6db74>&#34;https://github.com/my-org/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git config --global --add url.<span style=color:#e6db74>&#34;https://</span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>@github.com/my-org/&#34;</span>.insteadOf <span style=color:#e6db74>&#34;https://git@github.com/my-org/&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>RUN go mod vendor
</span></span><span style=display:flex><span>RUN go build -o main .</span></span></code></pre></div></div></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>docker-compose with service and postgres</h3><div id=outline-text-headline-3 class=outline-text-3><div class="src src-yaml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.0&#34;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>hello-service</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>Dockerfile.dev</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>       - <span style=color:#ae81ff>GITHUB_TOKEN</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>SERVER_PORT</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>   - <span style=color:#ae81ff>.:/go/src/github.com/my-org/hello-service</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;CompileDaemon -build=&#39;make build&#39; -command=&#39;./build/hello-service&#39;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>     - <span style=color:#e6db74>&#34;8000:80&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>postgres</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:12</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>     - <span style=color:#e6db74>&#34;5432:5432&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>app_user</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>app_password</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>hello_service</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>healthcheck</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>test</span>: [<span style=color:#e6db74>&#34;CMD-SHELL&#34;</span>, <span style=color:#e6db74>&#34;pg_isready -U ca&#34;</span>]
</span></span><span style=display:flex><span>     <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>3</span></span></span></code></pre></div></div></div></div></article></main></body></html>