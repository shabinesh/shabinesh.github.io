<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Notes</title><meta name=apple-mobile-web-app-title content="Notes"><link rel=stylesheet href=/main.css></head><body><main class=index><article><a href=/>back</a><header><h1>Mocking AWS Postgres Extensions <small>in notes</small></h1><small>2022-03-02</small></header><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Mocking AWS PG Extensions</h2><div id=outline-text-headline-1 class=outline-text-2><p>The project I am working on uses RDS with aws_s3 (& aws_commons)
postgres extensions. However these extensions are also need postgres
docker container used in the CI for integration tests to not break
the migrations. A mock extension was built to keep the tests from
breaking.</p><ul><li>Create <strong>.control</strong> files</li><li>Create the schema for the module being created</li><li>Add the functions in the schema in sql files</li></ul><p>In this case there are two <strong>.control</strong> files, <em>aws_common.control</em> & <em>aws_s3.control</em></p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>comment = &#39;aws_commons mock&#39;
</span></span><span style=display:flex><span>default_version = &#39;1.0&#39;
</span></span><span style=display:flex><span>module_pathname = &#39;$libdir/aws_commons&#39;
</span></span><span style=display:flex><span>relocatable = false</span></span></code></pre></div></div><figcaption><em>aws_common.control</em></figcaption></figure><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>comment = &#39;aws_s3 mock&#39;
</span></span><span style=display:flex><span>default_version = &#39;1.0&#39;
</span></span><span style=display:flex><span>module_pathname = &#39;$libdir/aws_s3&#39;
</span></span><span style=display:flex><span>relocatable = false</span></span></code></pre></div></div><figcaption><em>aws_s3.control</em></figcaption></figure><p>We then define the functions that these modules export in a file name
of the form <em>&lt;module_name>-&lt;default_version>.sql</em>.</p><figure><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>schema</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>exists</span> aws_commons;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>type</span> aws_commons.uri <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>   bucket varchar,
</span></span><span style=display:flex><span>   filepath varchar,
</span></span><span style=display:flex><span>   s3_region varchar
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>replace</span> <span style=color:#66d9ef>function</span> aws_commons.create_s3_uri(bucket varchar, filepath varchar, s3_region varchar) <span style=color:#66d9ef>returns</span> aws_commons.uri <span style=color:#66d9ef>as</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>row</span>(bucket, filepath, s3_region);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>language</span> plpgsql;</span></span></code></pre></div></div><figcaption><em>aws_commons–1.0.sql</em></figcaption></figure><figure><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>schema</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>exists</span> aws_s3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>replace</span> <span style=color:#66d9ef>function</span> aws_s3.table_import_from_s3(tbl varchar, cols varchar, opts varchar, uri aws_commons.uri) <span style=color:#66d9ef>returns</span> void <span style=color:#66d9ef>as</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>language</span> plpgsql;</span></span></code></pre></div></div><figcaption><em>aws_s3–1.0.sql</em></figcaption></figure><p>These are now installable and can be installed by copying them to the right path</p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>FROM postgres:12-alpine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENV POSTGRES_DB &#39;&#39;
</span></span><span style=display:flex><span>ENV POSTGRES_USER &#39;&#39;
</span></span><span style=display:flex><span>ENV POSTGRES_PASSWORD &#39;&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY dummy_extensions/extensions.sql /docker-entrypoint-initdb.d/
</span></span><span style=display:flex><span>COPY dummy_extensions/ /usr/local/share/postgresql/extension/</span></span></code></pre></div></div><figcaption><em>Dockerfile</em></figcaption></figure><p>And <em>extensions.sql</em> would install it when the containers boots up</p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>create extension aws_commons;
</span></span><span style=display:flex><span>create extension aws_s3;</span></span></code></pre></div></div><figcaption><em>extensions.sql</em></figcaption></figure><p>There are <a href=https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL.Procedural.Importing.html#aws_s3.table_import_from_s3>others functions</a> that could be mocked, this was all needed for me.</p></div></div></article></main></body></html>