<!doctype html><html lang=en-in><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=http://shabinesh.github.io/images/favicon.png><title>Mocking AWS Postgres Extensions | Sab's</title>
<meta name=title content="Mocking AWS Postgres Extensions"><meta name=description content="Mocking AWS PG Extensions The project I am working on uses RDS with aws_s3 (& aws_commons) postgres extensions. However these extensions are also need postgres docker container used in the CI for integration tests to not break the migrations. A mock extension was built to keep the tests from breaking. Create .control files Create the schema for the module being created Add the functions in the schema in sql files In this case there are two ."><meta name=keywords content="docker,aws,"><meta property="og:title" content="Mocking AWS Postgres Extensions"><meta property="og:description" content="Mocking AWS PG Extensions The project I am working on uses RDS with aws_s3 (& aws_commons) postgres extensions. However these extensions are also need postgres docker container used in the CI for integration tests to not break the migrations. A mock extension was built to keep the tests from breaking. Create .control files Create the schema for the module being created Add the functions in the schema in sql files In this case there are two ."><meta property="og:type" content="article"><meta property="og:url" content="http://shabinesh.github.io/blog/notes/mocking_aws_extensions/"><meta property="og:image" content="http://shabinesh.github.io/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-06-06T16:13:34+02:00"><meta property="article:modified_time" content="2020-06-06T16:13:34+02:00"><meta property="og:site_name" content="Sab's"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://shabinesh.github.io/images/share.png"><meta name=twitter:title content="Mocking AWS Postgres Extensions"><meta name=twitter:description content="Mocking AWS PG Extensions The project I am working on uses RDS with aws_s3 (& aws_commons) postgres extensions. However these extensions are also need postgres docker container used in the CI for integration tests to not break the migrations. A mock extension was built to keep the tests from breaking. Create .control files Create the schema for the module being created Add the functions in the schema in sql files In this case there are two ."><meta itemprop=name content="Mocking AWS Postgres Extensions"><meta itemprop=description content="Mocking AWS PG Extensions The project I am working on uses RDS with aws_s3 (& aws_commons) postgres extensions. However these extensions are also need postgres docker container used in the CI for integration tests to not break the migrations. A mock extension was built to keep the tests from breaking. Create .control files Create the schema for the module being created Add the functions in the schema in sql files In this case there are two ."><meta itemprop=datePublished content="2020-06-06T16:13:34+02:00"><meta itemprop=dateModified content="2020-06-06T16:13:34+02:00"><meta itemprop=wordCount content="261"><meta itemprop=image content="http://shabinesh.github.io/images/share.png"><meta itemprop=keywords content="docker,aws,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=/ class=title><h2>Sab's</h2></a><nav><a href=/>Home</a>
<a href=/blog>Blog</a></nav></header><main><h1>Mocking AWS Postgres Extensions</h1><p><i><time datetime=2020-06-06 pubdate>06 Jun, 2020</time></i></p><content><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Mocking AWS PG Extensions</h2><div id=outline-text-headline-1 class=outline-text-2><p>The project I am working on uses RDS with aws_s3 (& aws_commons)
postgres extensions. However these extensions are also need postgres
docker container used in the CI for integration tests to not break
the migrations. A mock extension was built to keep the tests from
breaking.</p><ul><li>Create <strong>.control</strong> files</li><li>Create the schema for the module being created</li><li>Add the functions in the schema in sql files</li></ul><p>In this case there are two <strong>.control</strong> files, <em>aws_common.control</em> & <em>aws_s3.control</em></p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>comment = &#39;aws_commons mock&#39;
</span></span><span style=display:flex><span>default_version = &#39;1.0&#39;
</span></span><span style=display:flex><span>module_pathname = &#39;$libdir/aws_commons&#39;
</span></span><span style=display:flex><span>relocatable = false</span></span></code></pre></div></div><figcaption><em>aws_common.control</em></figcaption></figure><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>comment = &#39;aws_s3 mock&#39;
</span></span><span style=display:flex><span>default_version = &#39;1.0&#39;
</span></span><span style=display:flex><span>module_pathname = &#39;$libdir/aws_s3&#39;
</span></span><span style=display:flex><span>relocatable = false</span></span></code></pre></div></div><figcaption><em>aws_s3.control</em></figcaption></figure><p>We then define the functions that these modules export in a file name
of the form <em>&lt;module_name>-&lt;default_version>.sql</em>.</p><figure><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>schema</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>exists</span> aws_commons;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>type</span> aws_commons.uri <span style=color:#66d9ef>as</span> (
</span></span><span style=display:flex><span>   bucket varchar,
</span></span><span style=display:flex><span>   filepath varchar,
</span></span><span style=display:flex><span>   s3_region varchar
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>replace</span> <span style=color:#66d9ef>function</span> aws_commons.create_s3_uri(bucket varchar, filepath varchar, s3_region varchar) <span style=color:#66d9ef>returns</span> aws_commons.uri <span style=color:#66d9ef>as</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>row</span>(bucket, filepath, s3_region);
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>language</span> plpgsql;</span></span></code></pre></div></div><figcaption><em>aws_commons–1.0.sql</em></figcaption></figure><figure><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>schema</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>exists</span> aws_s3;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>replace</span> <span style=color:#66d9ef>function</span> aws_s3.table_import_from_s3(tbl varchar, cols varchar, opts varchar, uri aws_commons.uri) <span style=color:#66d9ef>returns</span> void <span style=color:#66d9ef>as</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>language</span> plpgsql;</span></span></code></pre></div></div><figcaption><em>aws_s3–1.0.sql</em></figcaption></figure><p>These are now installable and can be installed by copying them to the right path</p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>FROM postgres:12-alpine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ENV POSTGRES_DB &#39;&#39;
</span></span><span style=display:flex><span>ENV POSTGRES_USER &#39;&#39;
</span></span><span style=display:flex><span>ENV POSTGRES_PASSWORD &#39;&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY dummy_extensions/extensions.sql /docker-entrypoint-initdb.d/
</span></span><span style=display:flex><span>COPY dummy_extensions/ /usr/local/share/postgresql/extension/</span></span></code></pre></div></div><figcaption><em>Dockerfile</em></figcaption></figure><p>And <em>extensions.sql</em> would install it when the containers boots up</p><figure><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>create extension aws_commons;
</span></span><span style=display:flex><span>create extension aws_s3;</span></span></code></pre></div></div><figcaption><em>extensions.sql</em></figcaption></figure><p>There are <a href=https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL.Procedural.Importing.html#aws_s3.table_import_from_s3>others functions</a> that could be mocked, this was all needed for me.</p></div></div></content><p><a href=http://shabinesh.github.io/tags/docker/>#docker</a>
<a href=http://shabinesh.github.io/tags/aws/>#aws</a></p></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>